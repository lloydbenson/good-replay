#!/usr/bin/env node

// Load modules

var Hoek = require('hoek');
var Fs = require('fs');
var Optimist = require('optimist');
var Nipple = require('nipple');
var Url = require('url');

// Declare internals

var internals = {};
internals.argv = Optimist.usage('Usage: $0 -l log.json -u url')
                    .demand(['l', 'u'])
                    .argv;

internals.getLog = function () {

    var log = [];
    var logPath = internals.argv.l[0] !== '/' ? process.cwd() + '/' + internals.argv.l : internals.argv.l;
    var logFile = Fs.readFileSync(logPath, 'utf8').split('\n');
    return logFile;
}

internals.parseUrls = function (options, entries) {
    
    internals.urls = [];
    for (var i = 0, il = entries.length; i < il-1; ++i) {

        var url = Hoek.clone(options);
        var entry = JSON.parse(entries[i]);
        if (entry.event === 'request' && entry.method === 'get') {

            if (entry.path) {

                url.path = entry.path;
                url.query = entry.query;
                url.headers = {};

                if (entry.log) {

                    for (var ei = 0, eil = entry.log.length; ei < eil; ++ei) {

                        var log = entry.log[ei];
                        if (!log.tags) {

                            continue;
                        }

                        if (log.tags.indexOf('state') !== -1) {

                            url.headers.Cookie = log.data;
                        }
                        else if (log.tags.indexOf('received') !== -1) {

                            url.headers['User-Agent'] = log.data.agent;
                        }
                    }
                }
                internals.urls.push(url);
            }
        }
    }
};

internals.makeRequest = function () {

    var url = internals.urls.pop();

    while (!url) {
        if (!internals.urls.length) {
            return;
        }

        url = internals.urls.pop();
    }

    var options = {
        rejectUnauthorized: false
    };
    Nipple.get(url, options, function (err, res, payload) {

        if (err) {

            console.log(err);
        }
//        console.log(res);
   });
};


internals.makeRequests = function () {

    console.log('Total requests to make: ' + internals.urls.length);
    console.log('Making requests...');
    for (var i = 0, il = internals.urls.length; i < il; ++i) {

        internals.makeRequest();
    }
};


internals.start = function () {

    var log = internals.getLog();
    internals.parseUrls(Url.parse(internals.argv.u), log);
    internals.makeRequests();
};

internals.start();
